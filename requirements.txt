import streamlit as st
import pandas as pd
import os
import re  # â† ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù‡Ù†Ø§
from openpyxl.styles import PatternFill, Font
from io import BytesIO

# ================== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© ==================
st.set_page_config(
    page_title="Admin Averroes",
    page_icon="ğŸ“Š",
    layout="wide"
)

# ================== ØªÙ†Ø³ÙŠÙ‚ Ù…Ø®ØµØµ ==================
st.markdown(
    """
    <style>
    body {
        background-color: #f0f8ff;
    }
    .main-title {
        font-size: 48px;
        color: #2E4053;
        font-weight: bold;
        text-align: center;
        padding: 20px 0;
    }
    .subtitle {
        font-size: 20px;
        color: #555;
        text-align: center;
        margin-bottom: 30px;
    }
    </style>
    """,
    unsafe_allow_html=True
)

# ================== Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© ==================
st.markdown("<div class='main-title'>Admin Averroes</div>", unsafe_allow_html=True)
st.markdown("<div class='subtitle'>By Mohamed Abd ElGhany</div>", unsafe_allow_html=True)

# ================== Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ==================
def sanitize_filename(name):
    s = str(name)
    s = re.sub(r'[^\w\s.-]', '_', s)
    s = re.sub(r'\s+', '_', s)
    return s.strip('_')[:100]

# ================== Ø¯Ø§Ù„Ø© ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¥ÙƒØ³Ù„ ==================
def split_excel_by_column(df, column_name):
    output_files = []
    unique_values = df[column_name].dropna().unique()

    for value in unique_values:
        filtered_df = df[df[column_name] == value]
        filename = f"{sanitize_filename(value)}.xlsx"

        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Ø¨Ø¯ÙˆÙ† Ø­ÙØ¸Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø±Øµ)
        output = BytesIO()
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            filtered_df.to_excel(writer, index=False, sheet_name="Data")
            ws = writer.sheets["Data"]
            fill = PatternFill(start_color="2E4053", end_color="2E4053", fill_type="solid")
            font = Font(bold=True, color="FFFFFF")
            for cell in ws[1]:
                cell.fill = fill
                cell.font = font

        output.seek(0)
        output_files.append((filename, output))

    return output_files

# ================== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ==================
st.markdown("---")

uploaded_file = st.file_uploader("ğŸ“ Upload Excel File (.xlsx)", type=["xlsx"])

if uploaded_file:
    df = pd.read_excel(uploaded_file)
    st.success("âœ… File uploaded successfully!")
    st.dataframe(df.head())

    columns = df.columns.tolist()
    selected_column = st.selectbox("ğŸ”½ Select Column to Split By:", columns)

    if st.button("ğŸš€ Split Excel"):
        output_files = split_excel_by_column(df, selected_column)
        st.success(f"âœ… Done! {len(output_files)} files created.")
        for filename, file_data in output_files:
            st.download_button(
                label=f"ğŸ“¥ Download {filename}",
                data=file_data,
                file_name=filename,
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
